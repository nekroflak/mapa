<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KAM — mapka</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}
    #map{height:100%;width:100%}

    /* side panel */
    #side-panel{
      position:absolute;bottom:20px;left:20px;width:320px;max-width:calc(100% - 40px);
      background:rgba(255,255,255,0.95);padding:12px;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.12);
      z-index:9999;max-height:70vh;overflow:auto;
    }
    #side-panel h3{margin:0 0 10px 0;font-size:18px}

    .region{
      margin-top:8px;padding:10px;border-radius:8px;color:#fff;font-weight:700;
      display:flex;align-items:center;justify-content:space-between;cursor:pointer;
      transition:transform .12s ease,box-shadow .12s ease,background-color .18s;user-select:none;
    }
    .region .title{flex:1}
    .region:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,0.08)}
    .region.highlight{outline:3px solid rgba(0,0,0,0.06);transform:translateY(-3px) scale(1.01)}

    /* animated names (no display:none) */
    .names{
      margin-top:6px;padding-left:8px;border-radius:6px;overflow:hidden;
      max-height:0;opacity:0;transition:max-height .32s cubic-bezier(.2,.9,.2,1),opacity .18s;
      background: rgba(255,255,255,0.02);
    }
    .names.open{opacity:1}
    .names div{padding:6px 8px;margin:6px 8px;border-radius:6px;background:rgba(0,0,0,0.03);color:#111;cursor:pointer}
    .names div:hover{background:rgba(0,0,0,0.06)}

    /* colors */
    .lubuskie-region{background:#6bb0c4}
    .pomorskie-region{background:#6bc48c}
    .mazowieckie-region{background:#c46b6b}
    /* Świętokrzyskie: tło żółtawe ale TEKST BIAŁY */
    .swietokrzyskie-region{background:#c4a36b;color:#fff}
    .dolnoslaskie-region{background:#a36bc4}
    .office-region,.lodzkie-region{background:#f0f0f0;color:#333}

    /* leaflet microinteraction styling */
    .leaflet-interactive{transition:stroke 180ms ease,stroke-width 180ms ease,fill-opacity 180ms ease;stroke-linecap:round;stroke-linejoin:round}
    @keyframes pulse{0%{stroke-width:4;stroke-opacity:1}40%{stroke-width:9;stroke-opacity:0.55}100%{stroke-width:4;stroke-opacity:1}}
    .leaflet-interactive.pulse{animation:pulse 1.1s ease-in-out infinite;filter:drop-shadow(0 6px 12px rgba(0,0,0,0.12))}

    @media (max-width:720px){#side-panel{left:10px;right:10px;width:auto;border-radius:12px 12px 0 0;bottom:8px}}
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="side-panel" aria-label="Panel KAMów">
    <h3>KAM na region ▼</h3>

    <div class="region lubuskie-region" data-key="lubuskie"><span class="title">Lubuskie | Zachodniopomorskie | Wielkopolskie</span><span class="caret">▾</span></div>
    <div class="names"><div data-person="Sochacki">• Sochacki</div><div data-person="Urbas">• Urbas</div><div data-person="Klim">• Klim</div><div data-person="Sikora">• Sikora</div></div>

    <div class="region pomorskie-region" data-key="pomorskie"><span class="title">Pomorskie | Kujawsko-Pomorskie | Warmińsko-Mazurskie</span><span class="caret">▾</span></div>
    <div class="names"><div data-person="Bołwan">• Bołwan</div><div data-person="Tantlewicz">• Tantlewicz</div><div data-person="Kunz">• Kunz</div></div>

    <div class="region mazowieckie-region" data-key="mazowieckie"><span class="title">Podlaskie | Mazowieckie</span><span class="caret">▾</span></div>
    <div class="names"><div data-person="Wójcik">• Wójcik</div><div data-person="Karwowski">• Karwowski</div><div data-person="Krupiński">• Krupiński</div><div data-person="Pawłowski">• Pawłowski</div><div data-person="Nesterowicz">• Nesterowicz</div></div>

    <div class="region swietokrzyskie-region" data-key="swietokrzyskie"><span class="title">Świętokrzyskie | Lubelskie | Małopolskie | Podkarpackie</span><span class="caret">▾</span></div>
    <div class="names"><div data-person="Osika">• Osika</div><div data-person="Szota">• Szota</div><div data-person="Boldys">• Boldys</div><div data-person="Grunt">• Grunt</div><div data-person="Kaczmarski">• Kaczmarski</div></div>

    <div class="region dolnoslaskie-region" data-key="dolnoslaskie"><span class="title">Dolnośląskie | Opolskie | Śląskie</span><span class="caret">▾</span></div>
    <div class="names"><div data-person="Motus-Zatoka">• Motus-Zatoka</div><div data-person="Koszewski">• Koszewski</div><div data-person="Olczak">• Olczak</div><div data-person="Jakubczyk">• Jakubczyk</div></div>

    <div class="region office-region" data-key="office"><span class="title">Office</span><span class="caret">▾</span></div>
    <div class="names"><div data-person="Kamińska">• Kamińska - Trójmiasto | Poznań | Wrocław</div><div data-person="Dębicka">• Dębicka - Kraków | Katowice</div><div data-person="Sieradz">• Sieradz - Warszawa</div><div data-person="Szkólski">• Szkólski - Łódź</div></div>

    <div class="region lodzkie-region" data-key="lodzkie"><span class="title">ŁÓDZKIE - Dla każdego KAM'a</span><span class="caret">▾</span></div>
    <div class="names"><div data-person="Bołwan-Łódź">• Bołwan jest z Łodzi — dawajmy mu tam jak możemy xd</div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
  (function(){
    // ustawienia: domyślnie zwinięte
    const OPEN_BY_DEFAULT = false;

    // inicjalizacja mapy
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Dla SDR — OpenStreetMap', maxZoom: 18 }).addTo(map);

    const southWest = L.latLng(49.00, 14.00), northEast = L.latLng(55.05, 24.15);
    const bounds = L.latLngBounds(southWest, northEast);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    L.Control.geocoder({ placeholder: "Wyszukaj miejscowość..." }).addTo(map);

    // panel elementy (tworzymy wcześniej, dostępne od razu)
    const panelRegions = Array.from(document.querySelectorAll('#side-panel .region'));
    const panelByKey = new Map(panelRegions.map(r => [r.dataset.key, r]));
    const namesBlocks = Array.from(document.querySelectorAll('#side-panel .names'));

    // funkcje otwierania/zamykania z animacją
    function openNames(block){
      if (!block) return;
      block.classList.add('open');
      block.style.maxHeight = block.scrollHeight + 'px';
      block.style.opacity = '1';
      block.setAttribute('aria-hidden','false');
    }
    function closeNames(block){
      if (!block) return;
      // ensure height measured
      block.style.maxHeight = block.scrollHeight + 'px';
      void block.offsetHeight;
      block.style.maxHeight = '0px';
      block.style.opacity = '0';
      block.setAttribute('aria-hidden','true');
      block.addEventListener('transitionend', function fn(e){
        if (e.propertyName === 'max-height'){ block.classList.remove('open'); block.removeEventListener('transitionend', fn); }
      });
    }

    // ustawienie domyślne (po DOMContentLoaded żeby scrollHeight było prawidłowe)
    document.addEventListener('DOMContentLoaded', () => {
      namesBlocks.forEach(nb => { if (OPEN_BY_DEFAULT) openNames(nb); else closeNames(nb); });
    });

    // attach kliknięcia + klawiatura
    panelRegions.forEach(region => {
      const next = region.nextElementSibling;
      region.addEventListener('click', () => {
        if (!next || !next.classList.contains('names')) return;
        if (next.classList.contains('open')) closeNames(next); else openNames(next);
      });
      region.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); if (next && next.classList.contains('names')) { if (next.classList.contains('open')) closeNames(next); else openNames(next); } }
      });
    });

    // konfiguracja mappingów (sprawdzone URL-e)
    const mapping = {
      mazowieckie: {
        url: 'https://gist.githubusercontent.com/nekroflak/90277d850a02049505bf97dd2c9fdeef/raw/0c247118cf65d0c61ff42dd6c7f819c74190bd29/gistfile1.json',
        color: '#c46b6b',
        tooltip: 'Sieradz, Szkólski (Office), Nesterowicz, Wójcik, Karwowski'
      },
      swietokrzyskie: {
        url: 'https://gist.githubusercontent.com/nekroflak/0b4d0d7852ed2ca7f28b3737cf0f4a8d/raw/b3180be2e7c6cc1e993fc5baf737d54f00b3bace/gistfile1.json',
        color: '#c4a36b',
        tooltip: 'Boldys, Dębicka(Office), Osika, Szota, Grunt, Kaczmarski'
      },
      dolnoslaskie: {
        url: 'https://gist.githubusercontent.com/nekroflak/953c5142079914d1264c935ceaded468/raw/5084adbbb1a852caf48afc204624d4c72264532f/gistfile1.json',
        color: '#a36bc4',
        tooltip: 'Motus, Olczak, Koszewski, Jakubczyk'
      },
      lubuskie: {
        url: 'https://gist.githubusercontent.com/nekroflak/38f48b87f01ed4906ba476944933c5a6/raw/aede39903a3d50681b9a0b65351fed1715a86429/gistfile1.json',
        color: '#6bb0c4',
        tooltip: 'Sochacki, Urbas, Sikora, Klim'
      },
      pomorskie: {
        url: 'https://gist.githubusercontent.com/nekroflak/7093ce1322339a6e057200a47a51b142/raw/39efa4c41a3c8f9efc998e000053e61e4b6e069e/gistfile1.json',
        color: '#6bc48c',
        tooltip: 'Bołwan, Tantlewicz, Kunz'
      }
    };

    // registry warstw
    const registry = {};

    // helpery highlight/pulse
    function setLayerHighlight(lg, color, on){
      if (!lg) return;
      lg.setStyle(() => on ? { color, weight: 4, fillOpacity: 0.55 } : { color, weight: 2, fillOpacity: 0.2 });
      if (on) try { lg.bringToFront(); } catch(e){}
    }
    function addPulseToLG(lg){ lg.eachLayer(f => { if (f && f._path) f._path.classList.add('pulse'); }); }
    function removePulseFromLG(lg){ lg.eachLayer(f => { if (f && f._path) f._path.classList.remove('pulse'); }); }

    // dodawanie GeoJSON i podpięcie interakcji
    function addGeoJSON(key, cfg){
      fetch(cfg.url)
        .then(res => { if (!res.ok) throw new Error('HTTP ' + res.status); return res.json(); })
        .then(geojson => {
          const lg = L.geoJSON(geojson, { style: { color: cfg.color, weight: 2, fillOpacity: 0.2 } }).addTo(map);
          lg.bindTooltip(cfg.tooltip, { permanent:false, direction:'center' });
          registry[key] = { layerGroup: lg, color: cfg.color, geojson };

          // małe opóźnienie żeby SVG path powstał
          setTimeout(() => lg.eachLayer(fl => { if (fl && fl._path) fl._path.classList.add('leaflet-interactive'); }), 50);

          // map -> panel
          lg.eachLayer(fl => {
            fl.on('mouseover', () => {
              setLayerHighlight(lg, cfg.color, true);
              if (fl._path) fl._path.classList.add('pulse');
              const p = panelByKey.get(key); if (p) p.classList.add('highlight');
            });
            fl.on('mouseout', () => {
              setLayerHighlight(lg, cfg.color, false);
              if (fl._path) fl._path.classList.remove('pulse');
              const p = panelByKey.get(key); if (p) p.classList.remove('highlight');
            });
            fl.on('click', () => {
              try { map.fitBounds(fl.getBounds(), { padding:[20,20], maxZoom:12 }); } catch(e){}
            });
          });

          // panel -> map
          const panelEl = panelByKey.get(key);
          if (panelEl){
            panelEl.addEventListener('mouseenter', () => { setLayerHighlight(lg, cfg.color, true); addPulseToLG(lg); });
            panelEl.addEventListener('mouseleave', () => { setLayerHighlight(lg, cfg.color, false); removePulseFromLG(lg); });
            panelEl.addEventListener('dblclick', () => {
              try {
                const bbox = bboxFromGeoJSON(registry[key].geojson);
                map.fitBounds([[bbox[1],bbox[0]],[bbox[3],bbox[2]]], { padding:[20,20], maxZoom:12 });
              } catch(e){}
            });
          }
        })
        .catch(err => {
          console.warn('Błąd ładowania GeoJSON dla', key, err);
          const panelEl = panelByKey.get(key);
          if (panelEl && !panelEl.querySelector('.load-error')) {
            const note = document.createElement('div'); note.className='load-error'; note.textContent='⚠️ Nie załadowano obszaru'; note.style.color='#a00'; note.style.fontSize='12px'; note.style.marginTop='6px';
            panelEl.insertAdjacentElement('afterend', note);
          }
        });
    }

    // dodajemy wszystkie
    Object.keys(mapping).forEach(k => addGeoJSON(k, mapping[k]));

    // bbox helper
    function bboxFromGeoJSON(obj){
      let coords = [];
      function collect(c){ if (!c) return; if (typeof c[0] === 'number' && typeof c[1] === 'number') coords.push(c); else c.forEach(collect); }
      if (!obj) return [0,0,0,0];
      if (obj.type === 'FeatureCollection') obj.features.forEach(f => collect(f.geometry.coordinates));
      else if (obj.type === 'Feature') collect(obj.geometry.coordinates);
      else if (obj.coordinates) collect(obj.coordinates);
      if (!coords.length) return [0,0,0,0];
      const xs = coords.map(c=>c[0]), ys = coords.map(c=>c[1]);
      return [Math.min(...xs), Math.min(...ys), Math.max(...xs), Math.max(...ys)];
    }

    // kliknięcie na nazwisko -> zoom + popup (bez błędów scope)
    document.querySelectorAll('.names').forEach(nb => {
      nb.addEventListener('click', ev => {
        const item = ev.target.closest('div[data-person]');
        if (!item) return;
        const header = nb.previousElementSibling;
        if (!header || !header.dataset || !header.dataset.key) return;
        const key = header.dataset.key;
        const person = item.dataset.person || item.textContent.trim();
        const entry = registry[key];
        if (entry && entry.geojson){
          // compute bbox once
          const bbox = bboxFromGeoJSON(entry.geojson);
          try { map.fitBounds([[bbox[1],bbox[0]],[bbox[3],bbox[2]]], { padding:[20,20], maxZoom:12 }); } catch(e){}
          setLayerHighlight(entry.layerGroup, entry.color, true);
          addPulseToLG(entry.layerGroup);
          const centerLat = (bbox[1] + bbox[3]) / 2;
          const centerLng = (bbox[0] + bbox[2]) / 2;
          L.popup({ maxWidth:240 }).setLatLng([centerLat, centerLng]).setContent(`<strong>${person}</strong><br/>Region: ${header.querySelector('.title').textContent}`).openOn(map);
          setTimeout(()=>{ setLayerHighlight(entry.layerGroup, entry.color, false); removePulseFromLG(entry.layerGroup); }, 2200);
        } else {
          // layer not ready yet
          console.warn('Warstwa dla', key, 'nie jest gotowa.');
          alert('może będzie, może nie XD');
        }
      });
    });

    // na resize dopasuj maxHeight naszych otwartych bloków
    window.addEventListener('resize', () => {
      document.querySelectorAll('.names.open').forEach(nb => nb.style.maxHeight = nb.scrollHeight + 'px');
    });

    // log
    setTimeout(()=>console.log('Init complete. OPEN_BY_DEFAULT=', OPEN_BY_DEFAULT, 'registry keys:', Object.keys(registry)), 1200);
  })();
  </script>
</body>
</html>


